<section id="screen-completion" class="mobile-screen">
    <canvas id="confetti" style="position:absolute; inset:0; pointer-events:none; z-index:10;"></canvas>

    <div class="completion-wrap">
        <div class="msg">
            <h2 class="title">Order Complete! ðŸŽ‰</h2>
            <p class="subtitle">Thank you for your purchase. Your order has been successfully processed.</p>
            <p class="order-line">Order No: <strong id="order-number">â€”</strong></p>
        </div>

        <form class="receipt-form" onsubmit="return false;">
            <label>Email address</label>
            <input id="receipt-email" type="email" placeholder="your@email.com" required />
            <label>Name (optional)</label>
            <input id="receipt-name" type="text" placeholder="Your name" />
            <button type="button" class="btn-primary" data-target="screen-home">Email me a copy of the receipt</button>
        </form>
    </div>

    <style>
        #screen-completion { position: relative; padding-top: 12px; }
        .completion-wrap { display:flex; flex-direction:column; gap:16px; opacity:0; transform: translateY(8px); transition: opacity 420ms ease, transform 420ms ease; }
        .completion-wrap.is-visible { opacity:1; transform: none; }
        .msg { text-align:center; }
        .title { margin:0 0 6px; font-size:1.4rem; color:#1b2538; }
        .subtitle { margin:0; color:#41536f; }
        .receipt-form { display:flex; flex-direction:column; gap:10px; }
        .receipt-form label { font-weight:600; color:#1b2538; }
        .receipt-form input { padding:10px 12px; border-radius:10px; border:1px solid rgba(31,69,114,0.25); font-size:0.95rem; }
        .receipt-form .btn-primary { width:100%; }
        .order-line { margin:8px 0 0; color:#1b2538; font-weight:600; letter-spacing:0.3px; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }
    </style>

    <script>
        // Confetti animation (based on dev.to tutorial approach)
        (function(){
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            let W=0, H=0, DPR = Math.max(1, window.devicePixelRatio || 1);
            function resize(){
                const parent = canvas.parentElement;
                const rect = parent.getBoundingClientRect();
                W = Math.max(1, rect.width);
                H = Math.max(1, rect.height);
                canvas.width = Math.floor(W * DPR);
                canvas.height = Math.floor(H * DPR);
                canvas.style.width = W + 'px';
                canvas.style.height = H + 'px';
                ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
            }
            window.addEventListener('resize', resize);
            // Delay a tick to ensure layout is ready when injected
            setTimeout(resize, 0);

            const colors = ['#6a9e7c','#5b68ff','#f0c419','#e76f51','#2a9d8f'];
            const pieces = [];
            const COUNT = 160;
            function spawn(){
                pieces.length = 0;
                for(let i=0;i<COUNT;i++){
                    const fromRight = Math.random() > 0.5;
                    const x = fromRight ? W + 6 : -6;
                    const y = H * (0.2 + Math.random()*0.4); // mid vertical band
                    const speedX = 200 + Math.random()*200; // inward burst
                    pieces.push({
                        x,
                        y,
                        size: 6 + Math.random()*7,
                        color: colors[(Math.random()*colors.length)|0],
                        angle: Math.random()*Math.PI,
                        angVel: (-2+Math.random()*4) * 0.06,
                        vx: fromRight ? -speedX : speedX, // shoot inward from sides
                        vy: -(80 + Math.random()*140) // slight pop upwards
                    });
                }
            }

            const duration = 2000; // ms
            let started;
            function draw(now){
                if (!W || !H){ requestAnimationFrame(draw); return; }
                if (started === undefined) started = now;
                ctx.clearRect(0,0,W,H);
                const dt = 1/60; // fixed timestep
                pieces.forEach(p=>{
                    p.vy += 320*dt; // gravity pulls down
                    p.x += p.vx*dt;
                    p.y += p.vy*dt;
                    p.angle += p.angVel;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
                    ctx.restore();
                });
                if (now - started < duration) {
                    requestAnimationFrame(draw);
                } else {
                    canvas.style.display='none';
                    const wrap = document.querySelector('.completion-wrap');
                    if (wrap) wrap.classList.add('is-visible');
                }
            }

            // Ensure proper sizing then spawn and draw
            requestAnimationFrame(()=>{ resize(); spawn(); requestAnimationFrame(draw); });
        })();

        // Generate a structured order number and persist it for this session
        (function(){
            function generateOrderId(){
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                // 6 uppercase base36 chars
                const seg = Math.random().toString(36).slice(2,8).toUpperCase();
                return `AYU-${y}${m}${day}-${seg}`;
            }
            let id = null;
            try { id = sessionStorage.getItem('orderId') || null; } catch(e) {}
            if (!id) { id = generateOrderId(); try { sessionStorage.setItem('orderId', id); } catch(e) {} }
            const el = document.getElementById('order-number');
            if (el) el.textContent = id;
        })();
    </script>
</section>
